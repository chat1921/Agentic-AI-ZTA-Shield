<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Agentic AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --bg-color: #f0f4f9;
            --surface-color: #ffffff;
            --text-color: #1f1f1f;
            --secondary-text-color: #5f6368;
            --border-color: #e0e0e0;
            --gemini-gradient: linear-gradient(90deg, #4285F4, #9B59B6, #EA4335, #FBBC05);
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
        }
        body {
            font-family: 'Google Sans', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 260px;
            background-color: var(--bg-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }
        .sidebar .sidebar-header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar .new-chat-btn {
            background: #eaf1fb;
            border: none;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1967d2;
            transition: background-color 0.2s;
        }
        .sidebar .new-chat-btn:hover { background-color: #d2e3fc; }
        .chat-history-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
        }
        .chat-history-list a {
            color: var(--secondary-text-color);
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 5px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-history-list a:hover { background-color: #e8f0fe; }
        .chat-history-list a.active {
            background-color: #d2e3fc;
            color: #1967d2;
        }
        .delete-btn {
            background: none; border: none; cursor: pointer; color: #a1a5aa;
            display: none;
        }
        .chat-history-list a:hover .delete-btn { display: inline; }
        .sidebar .sidebar-footer a {
            display: flex; align-items: center; gap: 15px;
        }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        /* Main chat styles from previous version are the same */
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding: 20px 0; height: 100vh; box-sizing: border-box; }
        .chat-history { width: 100%; max-width: 800px; flex-grow: 1; overflow-y: auto; padding: 0 20px; }
        .message-pair { margin-bottom: 30px; }
        .user-prompt, .model-response { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; }
        .user-avatar, .model-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; color: white; background: #6a82fb; flex-shrink: 0; }
        .model-avatar { background: var(--gemini-gradient); padding: 4px; }
        .model-avatar img { width: 100%; height: 100%; }
        .prompt-text { padding-top: 6px; font-size: 16px; font-weight: 500; }
        .response-content { padding-top: 6px; line-height: 1.7; }
        .response-content.error { color: #d93025; font-weight: 500; }
        .chat-input-container { width: 100%; max-width: 800px; padding: 10px 20px; }
        .chat-input { background-color: var(--surface-color); border-radius: 28px; box-shadow: var(--shadow); display: flex; align-items: center; padding: 5px 15px; }
        .chat-input textarea { flex-grow: 1; border: none; background: transparent; padding: 15px 10px; font-family: 'Google Sans', sans-serif; font-size: 16px; color: var(--text-color); resize: none; height: 24px; max-height: 200px; line-height: 24px; }
        .chat-input textarea:focus { outline: none; }
        .chat-input button { background: transparent; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .chat-input button:hover { background-color: #f0f4f9; }
        .chat-input button .material-symbols-outlined { font-size: 24px; color: var(--secondary-text-color); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>History</h2>
            <button class="new-chat-btn" id="newChatBtn">
                <span class="material-symbols-outlined">add</span> New Chat
            </button>
        </div>
        <div class="chat-history-list">
            {% for chat in chats %}
            <a href="/chat/{{ chat.id }}" class="{{ 'active' if chat.id == current_chat_id else '' }}">
                <span>{{ chat.title }}</span>
                <button class="delete-btn" data-chat-id="{{ chat.id }}">&times;</button>
            </a>
            {% endfor %}
        </div>
        <div class="sidebar-footer">
            <a href="/logout">
                <span class="material-symbols-outlined">logout</span> Logout
            </a>
        </div>
    </div>
    <div class="chat-main">
        <div class="chat-history" id="chatHistory">
            {% if messages %}
                {% for message in messages %}
                    {% if message.role == 'user' %}
                    <div class="message-pair">
                        <div class="user-prompt">
                            <div class="user-avatar">U</div>
                            <div class="prompt-text">{{ message.content }}</div>
                        </div>
                    {% elif message.role == 'model' %}
                        <div class="model-response">
                            <div class="model-avatar"><svg width="100%" height="100%" viewBox="0 0 36 36"><path d="M31.5 18C31.5 25.4558 25.4558 31.5 18 31.5C10.5442 31.5 4.5 25.4558 4.5 18C4.5 10.5442 10.5442 4.5 18 4.5C25.4558 4.5 31.5 10.5442 31.5 18Z" fill="url(#p0)"/><path d="M18 0C27.9411 0 36 8.05887 36 18C36 27.9411 27.9411 36 18 36C8.05887 36 0 27.9411 0 18C0 8.05887 8.05887 0 18 0ZM18 3C9.71573 3 3 9.71573 3 18C3 26.2843 9.71573 33 18 33C26.2843 33 33 26.2843 33 18C33 9.71573 26.2843 3 18 3Z" fill="url(#p1)"/><path d="M21.6871 18C21.6871 16.29 20.7381 14.7669 19.2639 13.9119C19.7439 13.4319 20.4081 13.1169 21.1581 13.1169C22.3931 13.1169 23.4131 14.1369 23.4131 15.3719C23.4131 16.6069 22.3931 17.6269 21.1581 17.6269C21.0281 17.6269 20.9031 17.6169 20.7781 17.5969C21.3281 17.6869 21.6871 17.8119 21.6871 18Z" fill="#F8E71C"/><path d="M12.5869 20.6281C12.5869 19.3931 13.6069 18.3731 14.8419 18.3731C16.0769 18.3731 17.0969 19.3931 17.0969 20.6281C17.0969 21.8631 16.0769 22.8831 14.8419 22.8831C13.6069 22.8831 12.5869 21.8631 12.5869 20.6281Z" fill="#7ED321"/><path d="M12.5869 15.3719C12.5869 14.1369 13.6069 13.1169 14.8419 13.1169C16.0769 13.1169 17.0969 14.1369 17.0969 15.3719C17.0969 16.6069 16.0769 17.6269 14.8419 17.6269C13.6069 17.6269 12.5869 16.6069 12.5869 15.3719Z" fill="#4A90E2"/><defs><linearGradient id="p0" x1="18" y1="4.5" x2="18" y2="31.5" gradientUnits="userSpaceOnUse"><stop stop-color="#4285F4"/><stop offset="1" stop-color="#9B59B6"/></linearGradient><linearGradient id="p1" x1="18" y1="0" x2="18" y2="36" gradientUnits="userSpaceOnUse"><stop stop-color="#EA4335"/><stop offset="1" stop-color="#FBBC05"/></linearGradient></defs></svg></div>
                            <div class="response-content">{{ message.content }}</div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        <div class="chat-input-container">
            <div class="chat-input">
                <textarea id="messageInput" placeholder="Enter a prompt here" rows="1"></textarea>
                <button type="submit" id="sendButton"><span class="material-symbols-outlined">send</span></button>
            </div>
        </div>
    </div>

    <script>
        // Use Jinja to safely pass the current_chat_id to JavaScript
        let currentChatId = {{ current_chat_id|tojson }};
        
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const newChatBtn = document.getElementById('newChatBtn');

        const geminiLogoSvg = `<svg width="100%" height="100%" viewBox="0 0 36 36"><path d="M31.5 18C31.5 25.4558 25.4558 31.5 18 31.5C10.5442 31.5 4.5 25.4558 4.5 18C4.5 10.5442 10.5442 4.5 18 4.5C25.4558 4.5 31.5 10.5442 31.5 18Z" fill="url(#p0)"/><path d="M18 0C27.9411 0 36 8.05887 36 18C36 27.9411 27.9411 36 18 36C8.05887 36 0 27.9411 0 18C0 8.05887 8.05887 0 18 0ZM18 3C9.71573 3 3 9.71573 3 18C3 26.2843 9.71573 33 18 33C26.2843 33 33 26.2843 33 18C33 9.71573 26.2843 3 18 3Z" fill="url(#p1)"/><path d="M21.6871 18C21.6871 16.29 20.7381 14.7669 19.2639 13.9119C19.7439 13.4319 20.4081 13.1169 21.1581 13.1169C22.3931 13.1169 23.4131 14.1369 23.4131 15.3719C23.4131 16.6069 22.3931 17.6269 21.1581 17.6269C21.0281 17.6269 20.9031 17.6169 20.7781 17.5969C21.3281 17.6869 21.6871 17.8119 21.6871 18Z" fill="#F8E71C"/><path d="M12.5869 20.6281C12.5869 19.3931 13.6069 18.3731 14.8419 18.3731C16.0769 18.3731 17.0969 19.3931 17.0969 20.6281C17.0969 21.8631 16.0769 22.8831 14.8419 22.8831C13.6069 22.8831 12.5869 21.8631 12.5869 20.6281Z" fill="#7ED321"/><path d="M12.5869 15.3719C12.5869 14.1369 13.6069 13.1169 14.8419 13.1169C16.0769 13.1169 17.0969 14.1369 17.0969 15.3719C17.0969 16.6069 16.0769 17.6269 14.8419 17.6269C13.6069 17.6269 12.5869 16.6069 12.5869 15.3719Z" fill="#4A90E2"/><defs><linearGradient id="p0" x1="18" y1="4.5" x2="18" y2="31.5" gradientUnits="userSpaceOnUse"><stop stop-color="#4285F4"/><stop offset="1" stop-color="#9B59B6"/></linearGradient><linearGradient id="p1" x1="18" y1="0" x2="18" y2="36" gradientUnits="userSpaceOnUse"><stop stop-color="#EA4335"/><stop offset="1" stop-color="#FBBC05"/></linearGradient></defs></svg>`;
        
        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // If this is the first message of a new chat, create the chat first
            if (!currentChatId) {
                const newChatResponse = await fetch('/new_chat', { method: 'POST' });
                const newChatData = await newChatResponse.json();
                if (newChatData.success) {
                    currentChatId = newChatData.chat_id;
                    // Redirect to the new chat URL to correctly handle state
                    window.location.href = `/chat/${currentChatId}`;
                    return; // The page will reload, so we stop here
                } else {
                    alert('Could not start a new chat.');
                    return;
                }
            }

            // --- UI Update ---
            messageInput.value = '';
            autoResizeTextarea(messageInput);
            createMessagePair(userMessage, true); // Create a pair with a thinking indicator
            const responseContentDiv = chatHistoryDiv.querySelector('.message-pair:last-child .response-content');
            
            // --- API Call ---
            try {
                const response = await fetch('/chat_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMessage, chat_id: currentChatId })
                });
                const result = await response.json();

                if (!response.ok) {
                    responseContentDiv.classList.add('error');
                    responseContentDiv.textContent = `Security Alert: ${result.error}`;
                    if (result.action === 'logout') {
                        setTimeout(() => {
                            alert('High-severity security violation detected. You are being logged out.');
                            window.location.href = '/login';
                        }, 1000);
                    }
                } else {
                    responseContentDiv.textContent = result.reply;
                }
            } catch (err) {
                responseContentDiv.classList.add('error');
                responseContentDiv.textContent = 'An error occurred connecting to the server.';
            }
        }

        function createMessagePair(userMessage, isAwaitingResponse = false) {
            const pairDiv = document.createElement('div');
            pairDiv.className = 'message-pair';
            let modelResponseHTML = '';
            if (isAwaitingResponse) {
                modelResponseHTML = `
                    <div class="model-response">
                        <div class="model-avatar">${geminiLogoSvg}</div>
                        <div class="response-content">Thinking...</div>
                    </div>`;
            }
            pairDiv.innerHTML = `
                <div class="user-prompt">
                    <div class="user-avatar">U</div>
                    <div class="prompt-text">${userMessage}</div>
                </div>
                ${modelResponseHTML}
            `;
            chatHistoryDiv.appendChild(pairDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        newChatBtn.addEventListener('click', async () => {
            const response = await fetch('/new_chat', { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                window.location.href = `/chat/${data.chat_id}`;
            } else {
                alert('Error starting a new chat.');
            }
        });
        
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const chatId = e.target.dataset.chatId;
                if (confirm('Are you sure you want to delete this chat?')) {
                    await fetch(`/delete_chat/${chatId}`, { method: 'POST' });
                    window.location.href = '/dashboard';
                }
            });
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));

        // Scroll to bottom on page load
        window.onload = () => {
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        };
    </script>
</body>
</html>